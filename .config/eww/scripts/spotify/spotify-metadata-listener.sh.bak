#!/bin/bash
# ~/.config/eww/scripts/spotify/spotify-metadata-listener.sh
# Outputs Song, Artist, Status, and Cover as a single line of JSON upon event.
# Requires: playerctl and jq

# --- Dependency Check ---
if ! command -v playerctl >/dev/null || ! command -v jq >/dev/null; then
    echo '{"status": "Error", "song": "Missing Deps", "artist": "N/A", "cover": ""}'
    exit 1
fi

# Function to get and print Song, Artist, Status, and Cover as JSON
get_metadata_json() {
    PLAYER_NAME="ncspot"

    if playerctl -p "$PLAYER_NAME" status &>/dev/null; then
        STATUS=$(playerctl -p "$PLAYER_NAME" status 2>/dev/null)
        SONG=$(playerctl -p "$PLAYER_NAME" metadata title 2>/dev/null)
        ARTIST=$(playerctl -p "$PLAYER_NAME" metadata artist 2>/dev/null)
        COVER=$(playerctl -p "$PLAYER_NAME" metadata mpris:artUrl 2>/dev/null)

        # Handle potentially empty cover URL and escape ampersands
        COVER_URL_ESCAPED="${COVER//&/\\&}"

        # Use jq -n -c for compact, single-line JSON output
        jq -n -c \
               --arg status "${STATUS:-Stopped}" \
               --arg song "${SONG:-Unknown Song}" \
               --arg artist "${ARTIST:-Unknown Artist}" \
               --arg cover "${COVER_URL_ESCAPED}" \
               '{status: $status, song: $song, artist: $artist, cover: $cover}'
    else
        # Player stopped: output default JSON
        echo '{"status": "Stopped", "song": "Nothing Playing", "artist": "N/A", "cover": ""}'
    fi
}

# 1. Print initial metadata
get_metadata_json

# 2. Start the event listener:
# We create a named pipe (FIFO) to safely merge the output streams from two independent follow commands.
# This is often more reliable than process substitution (&< or < <(...)) for persistent background processes.

FIFO_PIPE=$(mktemp -u)
mkfifo "$FIFO_PIPE"

# Start the two follow processes in the background, redirecting their output to the pipe
# Process 1: Follows metadata changes
playerctl -p "$PLAYER_NAME" --follow metadata > "$FIFO_PIPE" &
PID_METADATA=$!

# Process 2: Follows status changes (which includes play/pause)
playerctl -p "$PLAYER_NAME" --follow status > "$FIFO_PIPE" &
PID_STATUS=$!

# Monitor the pipe for any event that comes through
while read -r; do
    # Every time *something* is written to the pipe, refresh the metadata
    get_metadata_json
done < "$FIFO_PIPE"

# Cleanup: This part is rarely reached if Eww keeps the script running,
# but it's good practice for manual testing.
rm -f "$FIFO_PIPE"
kill $PID_METADATA $PID_STATUS 2>/dev/null
